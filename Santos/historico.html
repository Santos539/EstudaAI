<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Histórico - Estuda.AI</title>
    <style>
      :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --text-primary: #212529;
        --border-color: #dee2e6;
        --btn-primary: #000000;
        --btn-text: #ffffff;
        --accent: #000000;
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      [data-theme="dark"] {
        --bg-primary: #121212;
        --bg-secondary: #1e1e1e;
        --text-primary: #f8f9fa;
        --border-color: #444;
        --btn-primary: #ffffff;
        --btn-text: #000000;
        --accent: #ffffff;
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.7;
        transition: all 0.3s ease;
        padding-bottom: 80px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Cabeçalho */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 20px;
        border-bottom: 1px solid var(--border-color);
      }

      .logo img {
        height: 60px;
        border-radius: 50%;
        border: 2px solid var(--accent);
        cursor: pointer;
      }

      .header-buttons {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 10px 18px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        cursor: pointer;
        font-size: 0.95rem;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: var(--btn-primary);
        color: var(--btn-text);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--card-shadow);
      }

      /* Título */
      .page-title {
        text-align: center;
        padding: 40px 20px;
        font-size: 2.2rem;
      }

      /* Lista de Semanas */
      .week-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-top: 20px;
      }

      .week-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--card-shadow);
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .week-card:hover {
        transform: translateY(-5px);
      }

      .week-card h3 {
        margin-bottom: 10px;
        color: var(--btn-primary);
      }

      .week-card p {
        opacity: 0.8;
        font-size: 0.95rem;
      }

      /* Visualização da Semana */
      .week-view {
        display: none;
        margin-top: 40px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        padding: 25px;
      }

      .week-view h2 {
        margin-bottom: 20px;
        text-align: center;
      }

      .week-back-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 20px;
      }

      .schedule-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }

      .schedule-table th {
        background: var(--btn-primary);
        color: var(--btn-text);
        padding: 15px;
        text-align: left;
      }

      .schedule-table td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
      }

      .done-cell {
        color: #28a745;
        font-weight: bold;
      }

      .not-done-cell {
        color: #dc3545;
      }
    </style>

    <!-- Estilo do modal -->
    <style>
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 500px;
        padding: 25px;
        text-align: center;
        position: relative;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
      }

      .modal-overlay.show .modal {
        transform: translateY(0);
      }

      .modal h3 {
        font-size: 1.4rem;
        margin-bottom: 15px;
        color: var(--text-primary);
      }

      .modal p {
        font-size: 1rem;
        opacity: 0.9;
        margin-bottom: 20px;
      }

      .modal-btn {
        background: var(--btn-primary);
        color: var(--btn-text);
        border: none;
        padding: 10px 25px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        margin: 0 5px;
        transition: opacity 0.2s;
      }

      .modal-btn.cancel {
        background: transparent;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .modal-btn:hover {
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <!-- Cabeçalho -->
    <header>
      <div class="logo" id="logo">
        <img src="imagens/Logo Preta.png" alt="Estuda.AI" />
      </div>
      <div class="header-buttons">
        <button class="btn btn-primary" id="themeToggle">Tema Escuro</button>
      </div>
    </header>

    <div class="container">
      <h1 class="page-title">Semanas Arquivadas</h1>

      <!-- Lista de semanas -->
      <div class="week-list" id="weekList">
        <!-- Preenchido pelo JS -->
      </div>

      <!-- Visualização da semana -->
      <div class="week-view" id="weekView">
        <button class="week-back-btn" id="backToList">← Voltar à lista</button>
        <h2 id="viewWeekTitle">Semana 1</h2>
        <table class="schedule-table">
          <thead>
            <tr>
              <th>Dia</th>
              <th>Horário</th>
              <th>Matéria</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="viewScheduleBody">
            <!-- Preenchido pelo JS -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Botão Fixo "Voltar ao Perfil" -->
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000">
      <button
        class="btn btn-primary"
        style="
          padding: 14px 20px;
          font-size: 1rem;
          border-radius: 30px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
          transition: all 0.3s ease;
          min-width: 150px;
        "
        id="backToProfile"
      >
        Voltar ao Perfil
      </button>
    </div>

    <!-- Modal para exclusão -->
    <div class="modal-overlay" id="deleteModal">
      <div class="modal">
        <h3>Excluir Semana?</h3>
        <p>Essa ação não pode ser desfeita. Deseja continuar?</p>
        <button class="modal-btn cancel" id="cancelDelete">Cancelar</button>
        <button class="modal-btn" id="confirmDelete">Excluir</button>
      </div>
    </div>

    <script>
      // ====== 1. Verificação de Login ======
      const currentUser = localStorage.getItem("currentUser");
      if (!currentUser) {
        alert("Você precisa estar logado.");
        window.location.href = "login.html";
      }

      // ====== 2. Inicializa tema ======
      function initTheme() {
        const body = document.body;
        const themeToggle = document.getElementById("themeToggle");
        const logo = document.querySelector(".logo img");
        let isDark = localStorage.getItem("theme") === "dark";

        function setTheme(dark) {
          if (dark) {
            body.setAttribute("data-theme", "dark");
            themeToggle.textContent = "Tema Claro";
            logo.src = "imagens/Logo Branca.png";
          } else {
            body.removeAttribute("data-theme");
            themeToggle.textContent = "Tema Escuro";
            logo.src = "imagens/Logo Preta.png";
          }
          localStorage.setItem("theme", dark ? "dark" : "light");
        }

        setTheme(isDark);

        themeToggle.onclick = null;
        themeToggle.addEventListener("click", () => {
          isDark = !isDark;
          setTheme(isDark);
        });
      }

      document.addEventListener("DOMContentLoaded", initTheme);

      // ====== 3. Navegação ======
      document.getElementById("logo").addEventListener("click", () => {
        window.location.href = "index.html";
      });

      document.getElementById("backToProfile").onclick = () => {
        window.location.href = "perfil.html";
      };

      document.getElementById("backToList").onclick = () => {
        document.getElementById("weekView").style.display = "none";
        document.getElementById("weekList").style.display = "flex";
      };

      // Função auxiliar
      function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      // ====== 4. Mostrar lista de semanas arquivadas ======
      function showWeekList() {
        const weekCountKey = `weekCount_${currentUser}`;
        const weekCount =
          parseInt(localStorage.getItem(weekCountKey) || "1") - 1;
        const weekList = document.getElementById("weekList");
        weekList.innerHTML = "";

        if (weekCount === 0) {
          weekList.innerHTML = `
        <p style="text-align:center; padding:20px;">Nenhuma semana arquivada ainda.</p>
      `;
        } else {
          for (let i = 1; i <= weekCount; i++) {
            const weekData = localStorage.getItem(
              `archived_week_${currentUser}_${i}`
            );
            if (!weekData) continue;

            const card = document.createElement("div");
            card.className = "week-card";
            card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <h3>Semana ${i}</h3>
              <p>Clique para visualizar seu cronograma e progresso.</p>
            </div>
            <button class="delete-week-btn" data-week="${i}" style="
              background: #dc3545;
              color: white;
              border: none;
              width: 30px;
              height: 30px;
              border-radius: 50%;
              cursor: pointer;
              font-size: 1rem;
              display: flex;
              align-items: center;
              justify-content: center;
            " title="Excluir semana">✕</button>
          </div>
        `;
            card.onclick = () => showWeek(i);
            weekList.appendChild(card);
          }

          // Adiciona evento aos botões de exclusão
          document.querySelectorAll(".delete-week-btn").forEach((btn) => {
            btn.onclick = (e) => {
              e.stopPropagation();
              const weekNum = btn.getAttribute("data-week");
              confirmDeleteWeek(weekNum);
            };
          });
        }
      }

      // ====== 5. Mostrar detalhes da semana ======
      function showWeek(weekNumber) {
        const weekData = localStorage.getItem(
          `archived_week_${currentUser}_${weekNumber}`
        );
        const progressData = localStorage.getItem(
          `archived_progress_${currentUser}_${weekNumber}`
        );

        if (!weekData || !progressData) {
          alert("Esta semana foi excluída ou não existe.");
          return;
        }

        try {
          const parsedData = JSON.parse(weekData);
          const parsedProgress = JSON.parse(progressData);

          // Carrega o cronograma da IA arquivado (se existir)
          const iaCronogramaStr = localStorage.getItem(
            `ia_cronograma_${currentUser}_week${weekNumber}`
          );
          let iaCronograma = null;
          if (iaCronogramaStr) {
            iaCronograma = JSON.parse(iaCronogramaStr).cronograma || null;
          }

          document.getElementById("weekList").style.display = "none";
          document.getElementById("weekView").style.display = "block";
          document.getElementById(
            "viewWeekTitle"
          ).textContent = `Semana ${weekNumber}`;

          const tbody = document.getElementById("viewScheduleBody");
          tbody.innerHTML = "";

          parsedData.disponibilidade.forEach((dia) => {
            dia.horarios.forEach((horario) => {
              const row = document.createElement("tr");

              const tdDia = document.createElement("td");
              tdDia.textContent = dia.dia;

              const tdHora = document.createElement("td");
              tdHora.textContent = `${horario.inicio} – ${horario.fim}`;

              const tdMateria = document.createElement("td");

              // Usa o cronograma da IA se disponível
              const blocoIA = iaCronograma?.find(
                (b) =>
                  b.dia === dia.dia &&
                  b.horario.includes(horario.inicio.padStart(5, "0"))
              );

              if (blocoIA) {
                tdMateria.textContent = `${blocoIA.materia} — ${
                  blocoIA.tema
                } (${capitalize(blocoIA.tipo)})`;
              } else {
                tdMateria.textContent = "Matemática (Teoria e Exercícios)";
              }

              const tdStatus = document.createElement("td");
              const stateKey = `done_${currentUser}_${dia.dia}_${horario.inicio}`;
              const status = parsedProgress[stateKey] === "true";

              tdStatus.textContent = status ? "Concluído" : "Não feito";
              tdStatus.className = status ? "done-cell" : "not-done-cell";

              row.appendChild(tdDia);
              row.appendChild(tdHora);
              row.appendChild(tdMateria);
              row.appendChild(tdStatus);
              tbody.appendChild(row);
            });
          });
        } catch (e) {
          console.error("Erro ao carregar dados da semana:", e);
          document.getElementById("viewScheduleBody").innerHTML = `
        <tr><td colspan="4" style="text-align:center;">Erro ao carregar dados.</td></tr>
      `;
        }
      }

      // ====== 6. Confirmar exclusão com modal ======
      function confirmDeleteWeek(weekNumber) {
        const modal = document.getElementById("deleteModal");
        const confirmBtn = document.getElementById("confirmDelete");
        const cancelBtn = document.getElementById("cancelDelete");

        // Remove eventos antigos
        confirmBtn.onclick = null;
        cancelBtn.onclick = null;

        confirmBtn.onclick = () => {
          modal.classList.remove("show");
          // Remove todos os dados dessa semana
          localStorage.removeItem(`archived_week_${currentUser}_${weekNumber}`);
          localStorage.removeItem(
            `archived_progress_${currentUser}_${weekNumber}`
          );
          localStorage.removeItem(
            `ia_cronograma_${currentUser}_week${weekNumber}`
          );
          showWeekList(); // Atualiza a lista
        };

        cancelBtn.onclick = () => {
          modal.classList.remove("show");
        };

        modal.onclick = (e) => {
          if (e.target === modal) {
            modal.classList.remove("show");
          }
        };

        modal.classList.add("show");
      }

      // ====== 7. Carregar ao iniciar ======
      document.addEventListener("DOMContentLoaded", () => {
        initTheme();
        showWeekList();
      });
    </script>
  </body>
</html>
